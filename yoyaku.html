<div id="tab-content-stats" class="tab-content max-w-3xl mx-auto">
    <div id="stats-container" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
        </div>
</div>

<div id="tab-content-settings" class="tab-content max-w-2xl mx-auto">
    <div class="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
        <h3 class="font-bold text-xl mb-6 flex items-center"><i class="fas fa-clock mr-2 text-blue-500"></i>共通予約締切設定</h3>
        <hr class="my-8">
        
        <h3 class="font-bold text-xl mb-4 flex items-center text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i>危険な操作</h3>
        <div class="bg-red-50 p-4 rounded-lg border border-red-100">
            <p class="text-xs text-red-700 font-bold mb-3">全ユーザーの全期間の予約データを完全に消去します。この操作は取り消せません。</p>
            <button onclick="cancelAllReservations()" class="w-full bg-red-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-red-100 hover:bg-red-700 transition">
                全ての予約をキャンセル状態にする
            </button>
        </div>
    </div>
</div>

<script type="module">
    // --- 既存のimport等は維持 ---
    // ... (initializeApp, getFirestore 等)

    // --- 追加・修正した関数 ---

    /**
     * 1. 予約を全アカウントすべてキャンセル状態にする
     */
    window.cancelAllReservations = async () => {
        if (!confirm("本当に全てのアカウントの全予約を削除してもよろしいですか？\nこの操作は元に戻せません。")) return;
        
        try {
            const snap = await getDocs(ordersCol);
            if (snap.empty) {
                showToast("削除する予約データがありません", "info");
                return;
            }

            const batch = writeBatch(db);
            snap.forEach(d => {
                batch.delete(d.ref);
            });
            
            await batch.commit();
            showToast(`全 ${snap.size} 件の予約をキャンセルしました`, "success");
            
            // 統計画面にいれば再描画
            if (!document.getElementById('tab-content-stats').classList.contains('hidden')) {
                renderStats();
            }
        } catch (err) {
            console.error(err);
            showToast("一括削除中にエラーが発生しました", "error");
        }
    };

    /**
     * 2. 予約集計明細に再集計ボタンをつける
     */
    async function renderStats() {
        // ローディング表示（任意）
        const container = document.getElementById('stats-container');
        container.innerHTML = '<p class="text-center py-10">集計中...</p>';

        const ordersSnap = await getDocs(ordersCol);
        const orderMap = {};
        ordersSnap.forEach(d => { 
            const o = d.data(); 
            if (!orderMap[o.date]) orderMap[o.date] = 0; 
            orderMap[o.date]++; 
        });

        // ヘッダーと再集計ボタンの構築
        container.innerHTML = `
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg flex items-center">
                    <i class="fas fa-chart-pie mr-2 text-green-500"></i>予約集計明細
                </h3>
                <button onclick="renderStats()" class="text-xs bg-blue-50 text-blue-600 px-3 py-2 rounded-lg font-bold hover:bg-blue-100 transition">
                    <i class="fas fa-sync-alt mr-1"></i>再集計（最新に更新）
                </button>
            </div>
        `;

        const sortedDates = Object.keys(orderMap).sort((a, b) => b.localeCompare(a));
        
        if (sortedDates.length === 0) {
            container.innerHTML += '<p class="text-center text-gray-400 py-10">集計データがありません</p>';
            return;
        }

        sortedDates.forEach(date => {
            const div = document.createElement('div');
            div.className = "flex justify-between items-center border-b p-4 hover:bg-gray-50 transition";
            div.innerHTML = `
                <div class="font-bold text-gray-700">
                    ${date} <span class="ml-4 text-blue-600 font-black">${orderMap[date]}食</span>
                </div>
                <button onclick="downloadDailyOrderCSV('${date}')" class="text-[10px] bg-gray-800 text-white px-3 py-2 rounded-lg font-bold">
                    CSV出力
                </button>
            `;
            container.appendChild(div);
        });
    }

    // グローバルに登録（既存のコードとの整合性のため）
    window.renderStats = renderStats;

    // ... (その他の既存の関数群)
</script>
