F<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™©ã”é£¯å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: #e5e7eb;
        }
        .calendar-day {
            min-height: 100px;
            background-color: white;
            padding: 6px;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }
        .status-dinner-yes { background-color: #dcfce7 !important; border-left: 3px solid #22c55e; }
        .status-dinner-no { background-color: #fee2e2 !important; border-left: 3px solid #ef4444; }
        .status-trip { background-color: #fef9c3 !important; border-left: 3px solid #eab308; }
        .status-plan { background-color: #dbeafe !important; border-left: 3px solid #3b82f6; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        
        @media (max-width: 640px) {
            .calendar-day { min-height: 85px; font-size: 0.75rem; padding: 4px; }
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .comment-enter {
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-4xl mx-auto p-4 pb-20">
        <header class="flex justify-center items-center py-6">
            <h1 class="text-2xl font-extrabold text-slate-700 tracking-tight">æ™©ã”é£¯ãƒ»äºˆå®šå…±æœ‰</h1>
        </header>

        <div class="flex mb-6 border-b bg-white rounded-t-xl overflow-hidden shadow-sm">
            <button id="btn-view-calendar" class="flex-1 py-4 text-sm sm:text-base transition-all tab-active">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
            <button id="btn-view-batch" class="flex-1 py-4 text-sm sm:text-base text-slate-400 transition-all">ã¾ã¨ã‚ã¦å…¥åŠ›</button>
        </div>

        <section id="view-calendar">
            <div class="flex items-center justify-between mb-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                <button id="prev-month" class="p-2 hover:bg-slate-100 rounded-full w-10 h-10 flex items-center justify-center border border-slate-200 transition">â—€</button>
                <h2 id="month-display" class="text-lg font-bold text-slate-700"></h2>
                <button id="next-month" class="p-2 hover:bg-slate-100 rounded-full w-10 h-10 flex items-center justify-center border border-slate-200 transition">â–¶</button>
            </div>

            <div class="calendar-grid rounded-xl overflow-hidden border border-slate-200 shadow-md">
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-red-400 uppercase">Sun</div>
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-slate-500 uppercase">Mon</div>
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-slate-500 uppercase">Tue</div>
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-slate-500 uppercase">Wed</div>
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-slate-500 uppercase">Thu</div>
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-slate-500 uppercase">Fri</div>
                <div class="bg-slate-100 p-2 text-center text-[10px] font-bold text-blue-400 uppercase">Sat</div>
                <div id="calendar-days" class="contents"></div>
            </div>
        </section>

        <section id="view-batch" class="hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                <h3 class="font-bold mb-4 text-center border-b pb-3 text-slate-600">é€±é–“ãƒªã‚¹ãƒˆå…¥åŠ›</h3>
                <div id="week-tabs" class="flex gap-2 mb-6 overflow-x-auto py-2 no-scrollbar"></div>
                <div id="batch-input-list" class="space-y-4"></div>
            </div>
        </section>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl transition-all">
            <h3 id="modal-date-title" class="text-lg font-extrabold mb-4 text-center text-slate-700"></h3>
            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">çŠ¶æ…‹ã‚’é¸æŠ</label>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button data-status="dinner-yes" class="modal-status-btn py-3 bg-green-500 text-white rounded-xl font-bold text-sm active:scale-95 transition-transform">ã„ã‚‹</button>
                <button data-status="dinner-no" class="modal-status-btn py-3 bg-red-500 text-white rounded-xl font-bold text-sm active:scale-95 transition-transform">ä¸è¦</button>
                <button data-status="trip" class="modal-status-btn py-3 bg-yellow-400 text-white rounded-xl font-bold text-sm active:scale-95 transition-transform">å‡ºå¼µ</button>
                <button data-status="plan" class="modal-status-btn py-3 bg-blue-500 text-white rounded-xl font-bold text-sm active:scale-95 transition-transform">äºˆå®š</button>
            </div>
            <label class="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆä»»æ„ï¼‰</label>
            <textarea id="modal-comment" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none mb-4" rows="2" placeholder="ä¾‹: 20æ™‚å¸°å®…ã€å¤–é£Ÿãªã©"></textarea>
            <div class="flex flex-col gap-2">
                <button id="save-btn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold">ä¿å­˜ã™ã‚‹</button>
                <button data-status="clear" class="modal-status-btn w-full py-2 text-slate-400 text-xs font-medium">ç™»éŒ²ã‚’ã‚¯ãƒªã‚¢</button>
            </div>
            <button id="close-modal" class="mt-4 w-full text-slate-400 text-xs py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <div id="view-detail-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl transition-all">
            <h3 id="detail-date-title" class="text-lg font-extrabold mb-4 text-center text-slate-700"></h3>
            <div class="flex justify-center mb-6">
                <div id="detail-status-badge" class="px-6 py-2 rounded-full font-bold text-lg shadow-sm"></div>
            </div>
            <div class="bg-slate-50 p-4 rounded-2xl mb-6 min-h-[80px]">
                <p class="text-xs text-slate-400 font-bold mb-1 uppercase">ã‚³ãƒ¡ãƒ³ãƒˆ</p>
                <p id="detail-comment-text" class="text-sm text-slate-700 leading-relaxed italic"></p>
            </div>
            <div class="flex flex-col gap-2">
                <button id="btn-edit-existing" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg">å¤‰æ›´ã™ã‚‹</button>
                <button id="close-view-modal" class="w-full py-3 text-slate-400 text-sm font-medium">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyA4gVP3A9Ls3z0gKUFA0GmJu_pDgTYwg3s",
    authDomain: "family-acca5.firebaseapp.com",
    projectId: "family-acca5",
    storageBucket: "family-acca5.firebasestorage.app",
    messagingSenderId: "793497834481",
    appId: "1:793497834481:web:69dc5e8419fc7d467baa50",
    measurementId: "G-XE3HPDXEG5"
};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'family-dinner-sync'; // ä»»æ„ã®åå‰ã«å¤‰æ›´

        let currentDate = new Date();
        let user = null;
        let scheduleData = {};
        let selectedDateKey = null;
        let activeWeekIndex = 0;
        let selectedStatusModal = null;

        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                startSync();
            }
        });

        const startSync = () => {
            const colPath = `artifacts/${appId}/public/data/schedules`;
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
            onSnapshot(q, (snapshot) => {
                scheduleData = {};
                snapshot.forEach(doc => { scheduleData[doc.id] = doc.data(); });
                renderAll();
            }, (error) => console.error("Firestore sync error:", error));
        };

        const saveStatus = async (dateKey, status, comment) => {
            if (!user) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'schedules', dateKey);
            try {
                if (status === 'clear') {
                    await deleteDoc(docRef);
                } else {
                    await setDoc(docRef, {
                        status,
                        comment: (comment || '').trim(),
                        uid: user.uid,
                        updatedAt: serverTimestamp()
                    });
                }
                document.getElementById('edit-modal').classList.add('hidden');
                renderAll();
            } catch (err) { console.error("Save error:", err); }
        };

        const renderCalendar = () => {
            const container = document.getElementById('calendar-days');
            container.innerHTML = '';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('month-display').textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                container.appendChild(Object.assign(document.createElement('div'), { className: 'calendar-day bg-slate-50/50' }));
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = scheduleData[dateKey] || {};
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day cursor-pointer hover:bg-slate-50 border-b border-r border-slate-100 ${getStatusClass(data.status)}`;
                
                const commentIndicator = data.comment ? `<div class="text-[8px] mt-1 text-slate-600 truncate bg-white/60 px-1 rounded">ğŸ’¬ ${data.comment}</div>` : '';
                dayEl.innerHTML = `
                    <div class="text-[10px] font-bold ${getDayColorClass(year, month, d)}">${d}</div>
                    <div class="text-[10px] mt-auto font-bold text-center leading-tight">${getStatusLabel(data.status)}</div>
                    ${commentIndicator}
                `;
                dayEl.addEventListener('click', () => handleDayClick(dateKey));
                container.appendChild(dayEl);
            }
        };

        const renderBatchInput = () => {
            const tabs = document.getElementById('week-tabs');
            const list = document.getElementById('batch-input-list');
            tabs.innerHTML = '';
            list.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            const weeks = [];
            let currentWeek = [];
            for (let d = 1; d <= daysInMonth; d++) {
                currentWeek.push(d);
                if (new Date(year, month, d).getDay() === 6 || d === daysInMonth) {
                    weeks.push([...currentWeek]);
                    currentWeek = [];
                }
            }

            weeks.forEach((week, idx) => {
                const btn = document.createElement('button');
                btn.className = `px-5 py-2 rounded-full text-xs font-bold shrink-0 transition ${activeWeekIndex === idx ? 'bg-slate-700 text-white' : 'bg-slate-100 text-slate-500'}`;
                btn.textContent = `${idx + 1}é€±ç›®`;
                btn.onclick = () => { activeWeekIndex = idx; renderBatchInput(); };
                tabs.appendChild(btn);
            });

            if (weeks[activeWeekIndex]) {
                weeks[activeWeekIndex].forEach(d => {
                    const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const data = scheduleData[dateKey] || {};
                    const dateObj = new Date(year, month, d);
                    const dayLabel = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'][dateObj.getDay()];

                    const row = document.createElement('div');
                    row.className = 'p-4 bg-white rounded-2xl border border-slate-100 shadow-sm flex flex-col gap-3';
                    
                    const isSet = !!data.status;
                    
                    row.innerHTML = `
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-sm ${getDayColorClass(year, month, d)}">${d}æ—¥ (${dayLabel})</span>
                            <span class="text-[10px] font-bold px-3 py-1 rounded-full ${getStatusClass(data.status)} shadow-sm">
                                ${getStatusLabel(data.status) || 'æœªè¨­å®š'}
                            </span>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <button data-type="quick" data-date="${dateKey}" data-status="dinner-yes" class="py-2.5 text-[10px] font-bold rounded-xl border border-slate-100 ${data.status === 'dinner-yes' ? 'bg-green-100 ring-2 ring-green-400' : 'bg-slate-50'}">ã„ã‚‹</button>
                            <button data-type="quick" data-date="${dateKey}" data-status="dinner-no" class="py-2.5 text-[10px] font-bold rounded-xl border border-slate-100 ${data.status === 'dinner-no' ? 'bg-red-100 ring-2 ring-red-400' : 'bg-slate-50'}">ä¸è¦</button>
                            <button data-type="quick" data-date="${dateKey}" data-status="trip" class="py-2.5 text-[10px] font-bold rounded-xl border border-slate-100 ${data.status === 'trip' ? 'bg-yellow-100 ring-2 ring-yellow-400' : 'bg-slate-50'}">å‡ºå¼µ</button>
                            <button data-type="quick" data-date="${dateKey}" data-status="plan" class="py-2.5 text-[10px] font-bold rounded-xl border border-slate-100 ${data.status === 'plan' ? 'bg-blue-100 ring-2 ring-blue-400' : 'bg-slate-50'}">äºˆå®š</button>
                        </div>
                        ${isSet ? `
                        <div class="comment-enter flex flex-col gap-2 mt-1">
                            <textarea data-type="comment" data-date="${dateKey}" class="w-full p-2.5 text-xs bg-slate-50 border border-slate-200 rounded-xl outline-none" rows="1" placeholder="è©³ç´°ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›...">${data.comment || ''}</textarea>
                            <button data-type="quick" data-date="${dateKey}" data-status="clear" class="text-[10px] text-slate-400 self-end px-2">ã‚¯ãƒªã‚¢</button>
                        </div>` : ''}
                    `;
                    list.appendChild(row);
                });
            }
        };

        const renderAll = () => {
            renderCalendar();
            renderBatchInput();
        };

        const handleDayClick = (dateKey) => {
            selectedDateKey = dateKey;
            const data = scheduleData[dateKey];
            if (data && data.status) {
                const formatted = dateKey.split('-').map(v => parseInt(v));
                document.getElementById('detail-date-title').textContent = `${formatted[1]}æœˆ${formatted[2]}æ—¥ ã®è©³ç´°`;
                const badge = document.getElementById('detail-status-badge');
                badge.textContent = getStatusLabel(data.status);
                badge.className = `px-6 py-2 rounded-full font-bold text-lg shadow-sm ${getStatusClass(data.status)}`;
                document.getElementById('detail-comment-text').textContent = data.comment || 'ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“';
                document.getElementById('view-detail-modal').classList.remove('hidden');
            } else {
                openInputModal(dateKey);
            }
        };

        const openInputModal = (dateKey) => {
            selectedDateKey = dateKey;
            const data = scheduleData[dateKey] || {};
            const formatted = dateKey.split('-').map(v => parseInt(v));
            document.getElementById('modal-date-title').textContent = `${formatted[1]}æœˆ${formatted[2]}æ—¥ ã®äºˆå®šå…¥åŠ›`;
            selectedStatusModal = data.status || null;
            document.getElementById('modal-comment').value = data.comment || '';
            updateModalStatusButtons();
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        const updateModalStatusButtons = () => {
            document.querySelectorAll('.modal-status-btn[data-status]').forEach(btn => {
                const status = btn.getAttribute('data-status');
                if (status === 'clear') return;
                if (status === selectedStatusModal) {
                    btn.classList.add('ring-4', 'ring-slate-300', 'scale-105');
                } else {
                    btn.classList.remove('ring-4', 'ring-slate-300', 'scale-105');
                }
            });
        };

        const getStatusClass = (s) => {
            if (s === 'dinner-yes') return 'status-dinner-yes text-green-700';
            if (s === 'dinner-no') return 'status-dinner-no text-red-700';
            if (s === 'trip') return 'status-trip text-yellow-700';
            if (s === 'plan') return 'status-plan text-blue-700';
            return 'bg-slate-50 text-slate-400';
        };

        const getStatusLabel = (s) => {
            if (s === 'dinner-yes') return 'ğŸš ã„ã‚‹';
            if (s === 'dinner-no') return 'âœ– ä¸è¦';
            if (s === 'trip') return 'âœˆ å‡ºå¼µ';
            if (s === 'plan') return 'ğŸ“… äºˆå®š';
            return '';
        };

        const getDayColorClass = (y, m, d) => {
            const day = new Date(y, m, d).getDay();
            if (day === 0) return 'text-red-400';
            if (day === 6) return 'text-blue-400';
            return 'text-slate-500';
        };

        // Event Listeners for UI
        document.getElementById('btn-view-calendar').onclick = () => {
            document.getElementById('view-calendar').classList.remove('hidden');
            document.getElementById('view-batch').classList.add('hidden');
            document.getElementById('btn-view-calendar').classList.add('tab-active');
            document.getElementById('btn-view-batch').classList.remove('tab-active');
            document.getElementById('btn-view-batch').classList.add('text-slate-400');
        };
        document.getElementById('btn-view-batch').onclick = () => {
            document.getElementById('view-batch').classList.remove('hidden');
            document.getElementById('view-calendar').classList.add('hidden');
            document.getElementById('btn-view-batch').classList.add('tab-active');
            document.getElementById('btn-view-calendar').classList.remove('tab-active');
            document.getElementById('btn-view-calendar').classList.add('text-slate-400');
        };
        document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderAll(); };
        document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderAll(); };
        document.getElementById('close-modal').onclick = () => document.getElementById('edit-modal').classList.add('hidden');
        document.getElementById('close-view-modal').onclick = () => document.getElementById('view-detail-modal').classList.add('hidden');
        document.getElementById('btn-edit-existing').onclick = () => {
            document.getElementById('view-detail-modal').classList.add('hidden');
            openInputModal(selectedDateKey);
        };
        document.querySelectorAll('.modal-status-btn').forEach(btn => {
            btn.onclick = () => {
                const s = btn.getAttribute('data-status');
                if (s === 'clear') saveStatus(selectedDateKey, 'clear', '');
                else { selectedStatusModal = s; updateModalStatusButtons(); }
            };
        });
        document.getElementById('save-btn').onclick = () => saveStatus(selectedDateKey, selectedStatusModal, document.getElementById('modal-comment').value);

        // Delegation for batch list
        document.getElementById('batch-input-list').onclick = (e) => {
            const btn = e.target.closest('[data-type="quick"]');
            if (btn) {
                const dateKey = btn.getAttribute('data-date');
                const status = btn.getAttribute('data-status');
                const data = scheduleData[dateKey] || {};
                saveStatus(dateKey, status, data.comment || '');
            }
        };
        document.getElementById('batch-input-list').onchange = (e) => {
            const area = e.target.closest('[data-type="comment"]');
            if (area) {
                const dateKey = area.getAttribute('data-date');
                const data = scheduleData[dateKey] || {};
                if (data.status) saveStatus(dateKey, data.status, area.value);
            }
        };

        initAuth();
    </script>
</body>
</html>
