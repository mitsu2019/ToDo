<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>U-ToDo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // グローバル変数
        let user = null;
        let todos = [];
        let masters = { requesters: [], depts: [] };
        let isEditing = false;
        let currentSort = { key: 'deadline', asc: true };
        
        // Firebase関連の変数をスコープ外で宣言
        let app, auth, db;
        const appId = 'u-todo-app-default';

        // ---------------------------------------------------------
        // 1. UI操作関数
        // ---------------------------------------------------------

        // タブ切り替え
        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('tab-active', 'text-blue-600');
                el.classList.add('text-slate-500');
            });
            const targetContent = document.getElementById(`content-${tabId}`);
            if (targetContent) targetContent.classList.remove('hidden');
            
            const activeBtn = document.getElementById(`tab-${tabId}`);
            if (activeBtn) {
                activeBtn.classList.add('tab-active', 'text-blue-600');
            }
            if (tabId === 'input') updateSelects();
        };

        // モーダル開閉
        window.toggleMasterModal = (show) => {
            const modal = document.getElementById('master-modal');
            if (!modal) return;
            modal.classList.toggle('hidden', !show);
            if (!show) updateSelects();
        };

        // トースト表示
        window.showToast = (message, icon = '✅') => {
            const toast = document.getElementById('toast');
            if (!toast) return;
            document.getElementById('toast-icon').innerText = icon;
            document.getElementById('toast-message').innerText = message;
            toast.classList.remove('translate-y-24', 'opacity-0');
            toast.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => {
                toast.classList.add('translate-y-24', 'opacity-0');
                toast.classList.remove('translate-y-0', 'opacity-100');
            }, 3000);
        };

        // 編集キャンセル
        window.cancelEdit = () => {
            isEditing = false;
            document.getElementById('form-title').innerText = '新規タスク登録';
            document.getElementById('submit-btn').innerText = 'ToDoを登録';
            document.getElementById('cancel-edit-btn').classList.add('hidden');
            const form = document.getElementById('todo-form');
            if(form) form.reset();
            document.getElementById('f-id').value = '';
            const dateInput = document.getElementById('f-date');
            if (dateInput) dateInput.valueAsDate = new Date();
        };

        // ToDo編集モードへ
        window.editTodo = (id) => {
            const todo = todos.find(t => t.id == id);
            if (!todo) return;
            isEditing = true;
            document.getElementById('form-title').innerText = 'ToDoの内容を編集';
            document.getElementById('submit-btn').innerText = '変更を保存する';
            document.getElementById('cancel-edit-btn').classList.remove('hidden');
            
            document.getElementById('f-id').value = id;
            if(todo.requester) document.getElementById('f-requester').value = todo.requester;
            if(todo.dept) document.getElementById('f-dept').value = todo.dept;
            if(todo.status) document.getElementById('f-status').value = todo.status;
            if(todo.date) document.getElementById('f-date').value = todo.date;
            if(todo.deadline) document.getElementById('f-deadline').value = todo.deadline;
            if(todo.content) document.getElementById('f-content').value = todo.content;
            if(todo.report) document.getElementById('f-report').value = todo.report;
            
            switchTab('input');
        };

        // ソート機能
        window.sortTable = (key) => {
            if (currentSort.key === key) currentSort.asc = !currentSort.asc;
            else { currentSort.key = key; currentSort.asc = true; }
            renderTodos();
        };

        // ---------------------------------------------------------
        // 2. データ操作ロジック
        // ---------------------------------------------------------

        function updateSelects() {
            const rSelect = document.getElementById('f-requester');
            const dSelect = document.getElementById('f-dept');
            if (!rSelect || !dSelect) return;

            const currentR = rSelect.value;
            const currentD = dSelect.value;

            const safeRequesters = Array.isArray(masters.requesters) ? masters.requesters : [];
            const safeDepts = Array.isArray(masters.depts) ? masters.depts : [];

            rSelect.innerHTML = '<option value="">選択してください</option>' + 
                safeRequesters.map(v => `<option value="${v}">${v}</option>`).join('');
            dSelect.innerHTML = '<option value="">選択してください</option>' + 
                safeDepts.map(v => `<option value="${v}">${v}</option>`).join('');
            
            if(currentR) rSelect.value = currentR;
            if(currentD)
