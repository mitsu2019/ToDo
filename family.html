<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; }
        .calendar-day { min-height: 100px; background-color: white; padding: 4px; display: flex; flex-direction: column; gap: 2px; }
        .bg-dinner-yes { background-color: #dcfce7; border-left: 3px solid #22c55e; }
        .bg-dinner-no { background-color: #fee2e2; border-left: 3px solid #ef4444; }
        .bg-has-plan { border-right: 3px solid #3b82f6; }
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        /* ãƒ­ãƒƒã‚¯ç”»é¢ç”¨ */
        #lock-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        @media (max-width: 640px) { .calendar-day { min-height: 90px; font-size: 0.7rem; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="lock-screen">
        <div class="p-8 bg-white rounded-3xl shadow-xl border border-slate-100 text-center max-w-xs w-full">
            <h2 class="text-xl font-bold mb-6 text-slate-700">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›</h2>
            <input type="password" id="pass-input" class="w-full p-4 bg-slate-50 border rounded-2xl mb-4 text-center text-lg focus:ring-2 focus:ring-slate-300 outline-none" placeholder="Password">
            <button id="unlock-btn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold shadow-lg active:bg-slate-700">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <p id="pass-error" class="text-red-500 text-xs mt-3 hidden">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
        </div>
    </div>

    <div id="app" class="max-w-4xl mx-auto p-4 pb-20 opacity-0 transition-opacity duration-500">
        <header class="flex justify-center items-center py-4">
            <h1 id="title" class="text-xl font-extrabold text-slate-700">ãƒ•ã‚¡ãƒŸãƒªãƒ¼ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
        </header>

        <div class="flex mb-4 border-b bg-white rounded-t-xl overflow-hidden shadow-sm">
            <button id="btn-view-calendar" class="flex-1 py-4 tab-active">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
            <button id="btn-view-batch" class="flex-1 py-4 text-slate-400">ã¾ã¨ã‚ã¦å…¥åŠ›</button>
        </div>

        <section id="view-calendar">
            <div class="flex items-center justify-between mb-4 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                <button id="prev-month" class="p-2 border rounded-full">â—€</button>
                <h2 id="month-display" class="font-bold"></h2>
                <button id="next-month" class="p-2 border rounded-full">â–¶</button>
            </div>
            <div class="calendar-grid rounded-xl overflow-hidden border border-slate-200 shadow-md">
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-red-400">Sun</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Mon</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Tue</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Wed</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Thu</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Fri</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-blue-400">Sat</div>
                <div id="calendar-days" class="contents"></div>
            </div>
        </section>

        <section id="view-batch" class="hidden">
            <div id="batch-input-list" class="space-y-3"></div>
        </section>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl">
            <h3 id="modal-date-title" class="text-lg font-extrabold mb-4 text-center border-b pb-2"></h3>
            <p class="text-xs font-bold text-slate-400 mb-2">ğŸš æ™©ã”é£¯</p>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button data-group="dinner" data-status="dinner-yes" class="modal-btn py-3 bg-slate-100 rounded-xl font-bold">ã„ã‚‹</button>
                <button data-group="dinner" data-status="dinner-no" class="modal-btn py-3 bg-slate-100 rounded-xl font-bold">ä¸è¦</button>
            </div>
            <p class="text-xs font-bold text-slate-400 mb-2">ğŸ“… äºˆå®š</p>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button data-group="isTrip" class="modal-toggle-btn py-3 bg-slate-100 rounded-xl font-bold">å‡ºå¼µ</button>
                <button data-group="isPlan" class="modal-toggle-btn py-3 bg-slate-100 rounded-xl font-bold">äºˆå®š</button>
            </div>
            <div id="modal-comment-container" class="hidden">
                <textarea id="modal-comment" class="w-full p-3 bg-slate-50 border rounded-xl text-sm mb-4" rows="2" placeholder="è©³ç´°ã‚’å…¥åŠ›..."></textarea>
            </div>
            <button id="save-btn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold mb-2">ä¿å­˜ã™ã‚‹</button>
            <button id="close-modal" class="w-full text-slate-400 text-xs py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4gVP3A9Ls3z0gKUFA0GmJu_pDgTYwg3s",
            authDomain: "family-acca5.firebaseapp.com",
            projectId: "family-acca5",
            storageBucket: "family-acca5.firebasestorage.app",
            messagingSenderId: "793497834481",
            appId: "1:793497834481:web:69dc5e8419fc7d467baa50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = "schedules_v3";
        const APP_PASSWORD = "family"; // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®š

        let currentDate = new Date();
        let user = null;
        let scheduleData = {};
        let selectedDateKey = null;
        let editState = { dinner: null, isTrip: false, isPlan: false };

        // --- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼æ©Ÿèƒ½ ---
        document.getElementById('unlock-btn').onclick = () => {
            const val = document.getElementById('pass-input').value;
            if (val === APP_PASSWORD) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app').classList.remove('opacity-0');
                localStorage.setItem('family_app_unlocked', 'true');
            } else {
                document.getElementById('pass-error').classList.remove('hidden');
            }
        };

        // éå»ã«èªè¨¼æ¸ˆã¿ã‹ãƒã‚§ãƒƒã‚¯
        if (localStorage.getItem('family_app_unlocked') === 'true') {
            document.getElementById('lock-screen').style.display = 'none';
            document.getElementById('app').classList.remove('opacity-0');
        }

        // --- ä»¥ä¸‹ã€æ—¢å­˜ã®æç”»ãƒ»åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ ---
        const renderAll = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('month-display').textContent = `${year}å¹´ ${month + 1}æœˆ`;
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const calContainer = document.getElementById('calendar-days');
            calContainer.innerHTML = '';
            for (let i = 0; i < firstDay; i++) calContainer.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const data = scheduleData[dateKey] || {};
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day border-b border-r cursor-pointer ${data.dinner === 'dinner-yes' ? 'bg-dinner-yes' : data.dinner === 'dinner-no' ? 'bg-dinner-no' : ''} ${ (data.isTrip || data.isPlan) ? 'bg-has-plan' : ''}`;
                let labels = '';
                if(data.dinner === 'dinner-yes') labels += 'ğŸš';
                if(data.dinner === 'dinner-no') labels += 'âœ–';
                if(data.isTrip) labels += 'âœˆ';
                if(data.isPlan) labels += 'ğŸ“…';
                dayEl.innerHTML = `
                    <div class="text-[9px] font-bold text-slate-400">${d}</div>
                    <div class="text-center text-xs">${labels}</div>
                    <div class="text-[8px] text-slate-500 truncate">${data.comment || ''}</div>
                `;
                dayEl.onclick = () => window.openModal(dateKey);
                calContainer.appendChild(dayEl);
            }
            const list = document.getElementById('batch-input-list');
            list.innerHTML = '';
            for (let d = 1; d <= daysInMonth; d++) {
                const dateKey = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const data = scheduleData[dateKey] || {};
                const row = document.createElement('div');
                row.className = 'p-3 bg-white rounded-xl border shadow-sm flex flex-col gap-2';
                row.innerHTML = `
                    <div class="flex justify-between font-bold text-xs"><span>${d}æ—¥</span><span class="text-slate-400 text-[10px] truncate max-w-[150px]">${data.comment || ''}</span></div>
                    <div class="grid grid-cols-4 gap-1">
                        <button onclick="window.quickSaveDinner('${dateKey}', 'dinner-yes')" class="py-2 text-[10px] rounded-lg border ${data.dinner==='dinner-yes'?'bg-green-500 text-white font-bold':'bg-slate-50 text-slate-400'}">ã„ã‚‹</button>
                        <button onclick="window.quickSaveDinner('${dateKey}', 'dinner-no')" class="py-2 text-[10px] rounded-lg border ${data.dinner==='dinner-no'?'bg-red-500 text-white font-bold':'bg-slate-50 text-slate-400'}">ä¸è¦</button>
                        <button onclick="window.openModal('${dateKey}')" class="py-2 text-[10px] rounded-lg border ${data.isTrip?'bg-yellow-400 text-white font-bold':'bg-slate-50 text-slate-400'}">å‡ºå¼µ${data.isTrip?'â—':''}</button>
                        <button onclick="window.openModal('${dateKey}')" class="py-2 text-[10px] rounded-lg border ${data.isPlan?'bg-blue-500 text-white font-bold':'bg-slate-50 text-slate-400'}">äºˆå®š${data.isPlan?'â—':''}</button>
                    </div>
                `;
                list.appendChild(row);
            }
        };

        window.openModal = (dateKey) => {
            selectedDateKey = dateKey;
            const data = scheduleData[dateKey] || { dinner: null, isTrip: false, isPlan: false, comment: '' };
            editState = { dinner: data.dinner, isTrip: data.isTrip || false, isPlan: data.isPlan || false };
            document.getElementById('modal-date-title').textContent = dateKey;
            document.getElementById('modal-comment').value = data.comment || '';
            updateModalUI();
            document.getElementById('edit-modal').classList.remove('hidden');
        };

        window.quickSaveDinner = async (dateKey, status) => {
            const data = scheduleData[dateKey] || { dinner: null, isTrip: false, isPlan: false, comment: '' };
            const newValue = (data.dinner === status) ? null : status;
            await setDoc(doc(db, COLLECTION_NAME, dateKey), { ...data, dinner: newValue, updatedAt: serverTimestamp() });
        };

        const updateModalUI = () => {
            document.querySelectorAll('[data-group="dinner"]').forEach(btn => {
                const isActive = editState.dinner === btn.dataset.status;
                const colors = { 'dinner-yes': 'bg-green-500 text-white', 'dinner-no': 'bg-red-500 text-white' };
                btn.className = `modal-btn py-3 rounded-xl font-bold transition-all ${isActive ? colors[btn.dataset.status] : 'bg-slate-100 text-slate-400'}`;
            });
            const toggleBtns = { isTrip: 'bg-yellow-400 text-white', isPlan: 'bg-blue-500 text-white' };
            Object.keys(toggleBtns).forEach(key => {
                const btn = document.querySelector(`[data-group="${key}"]`);
                btn.className = `modal-toggle-btn py-3 rounded-xl font-bold transition-all ${editState[key] ? toggleBtns[key] : 'bg-slate-100 text-slate-400'}`;
            });
            document.getElementById('modal-comment-container').classList.toggle('hidden', !(editState.isTrip || editState.isPlan));
        };

        document.querySelectorAll('.modal-btn').forEach(btn => { btn.onclick = () => { editState.dinner = (editState.dinner === btn.dataset.status) ? null : btn.dataset.status; updateModalUI(); }; });
        document.querySelectorAll('.modal-toggle-btn').forEach(btn => { btn.onclick = () => { const key = btn.dataset.group; editState[key] = !editState[key]; updateModalUI(); }; });
        document.getElementById('save-btn').onclick = async () => {
            const comment = document.getElementById('modal-comment').value;
            await setDoc(doc(db, COLLECTION_NAME, selectedDateKey), { ...editState, comment: comment.trim(), updatedAt: serverTimestamp() });
            document.getElementById('edit-modal').classList.add('hidden');
        };
        document.getElementById('close-modal').onclick = () => document.getElementById('edit-modal').classList.add('hidden');
        document.getElementById('prev-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()-1); renderAll(); };
        document.getElementById('next-month').onclick = () => { currentDate.setMonth(currentDate.getMonth()+1); renderAll(); };
        document.getElementById('btn-view-calendar').onclick = () => { document.getElementById('view-calendar').classList.remove('hidden'); document.getElementById('view-batch').classList.add('hidden'); document.getElementById('btn-view-calendar').classList.add('tab-active'); document.getElementById('btn-view-batch').classList.remove('tab-active'); };
        document.getElementById('btn-view-batch').onclick = () => { document.getElementById('view-batch').classList.remove('hidden'); document.getElementById('view-calendar').classList.add('hidden'); document.getElementById('btn-view-batch').classList.add('tab-active'); document.getElementById('btn-view-calendar').classList.remove('tab-active'); };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('title').style.color = '#22c55e';
                onSnapshot(collection(db, COLLECTION_NAME), (snap) => {
                    scheduleData = {};
                    snap.forEach(d => scheduleData[d.id] = d.data());
                    renderAll();
                });
            } else { signInAnonymously(auth); }
        });
        renderAll();
    </script>
</body>
</html>
