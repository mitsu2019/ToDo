<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™©ã”é£¯å…±æœ‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; }
        .calendar-day { min-height: 100px; background-color: white; padding: 4px; display: flex; flex-direction: column; gap: 2px; }
        .bg-dinner-yes { background-color: #dcfce7; border-left: 3px solid #22c55e; }
        .bg-dinner-no { background-color: #fee2e2; border-left: 3px solid #ef4444; }
        .bg-has-plan { border-right: 3px solid #3b82f6; } /* äºˆå®šãŒã‚ã‚‹å ´åˆã¯å³å´ã«é’ç·š */
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: bold; }
        @media (max-width: 640px) { .calendar-day { min-height: 90px; font-size: 0.7rem; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-4xl mx-auto p-4 pb-20">
        <header class="flex justify-center items-center py-4">
            <h1 class="text-xl font-extrabold text-slate-700">æ™©ã”é£¯ãƒ»äºˆå®šå…±æœ‰</h1>
        </header>

        <div class="flex mb-4 border-b bg-white rounded-t-xl overflow-hidden shadow-sm">
            <button id="btn-view-calendar" class="flex-1 py-4 tab-active">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º</button>
            <button id="btn-view-batch" class="flex-1 py-4 text-slate-400">ã¾ã¨ã‚ã¦å…¥åŠ›</button>
        </div>

        <section id="view-calendar">
            <div class="flex items-center justify-between mb-4 bg-white p-3 rounded-xl shadow-sm border border-slate-200">
                <button id="prev-month" class="p-2 border rounded-full">â—€</button>
                <h2 id="month-display" class="font-bold"></h2>
                <button id="next-month" class="p-2 border rounded-full">â–¶</button>
            </div>
            <div class="calendar-grid rounded-xl overflow-hidden border border-slate-200 shadow-md">
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-red-400">Sun</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Mon</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Tue</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Wed</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Thu</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-slate-500">Fri</div>
                <div class="bg-slate-100 p-1 text-center text-[10px] font-bold text-blue-400">Sat</div>
                <div id="calendar-days" class="contents"></div>
            </div>
        </section>

        <section id="view-batch" class="hidden">
            <div id="batch-input-list" class="space-y-3"></div>
        </section>
    </div>

    <div id="edit-modal" class="fixed inset-0 bg-slate-900/60 hidden flex items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-sm w-full p-6 shadow-2xl">
            <h3 id="modal-date-title" class="text-lg font-extrabold mb-4 text-center border-b pb-2"></h3>
            
            <p class="text-xs font-bold text-slate-400 mb-2">ğŸš æ™©ã”é£¯ï¼ˆã©ã¡ã‚‰ã‹ï¼‘ã¤ï¼‰</p>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button data-group="dinner" data-status="dinner-yes" class="modal-btn py-3 bg-slate-100 rounded-xl font-bold">ã„ã‚‹</button>
                <button data-group="dinner" data-status="dinner-no" class="modal-btn py-3 bg-slate-100 rounded-xl font-bold">ä¸è¦</button>
            </div>

            <p class="text-xs font-bold text-slate-400 mb-2">ğŸ“… äºˆå®šï¼ˆã©ã¡ã‚‰ã‹ï¼‘ã¤ï¼‰</p>
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button data-group="plan" data-status="trip" class="modal-btn py-3 bg-slate-100 rounded-xl font-bold">å‡ºå¼µ</button>
                <button data-group="plan" data-status="plan" class="modal-btn py-3 bg-slate-100 rounded-xl font-bold">äºˆå®š</button>
            </div>

            <div id="modal-comment-container" class="hidden">
                <textarea id="modal-comment" class="w-full p-3 bg-slate-50 border rounded-xl text-sm mb-4" rows="2" placeholder="è©³ç´°ã‚’å…¥åŠ›..."></textarea>
            </div>
            
            <button id="save-btn" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold mb-2">ä¿å­˜ã™ã‚‹</button>
            <button id="close-modal" class="w-full text-slate-400 text-xs py-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA4gVP3A9Ls3z0gKUFA0GmJu_pDgTYwg3s",
            authDomain: "family-acca5.firebaseapp.com",
            projectId: "family-acca5",
            storageBucket: "family-acca5.firebasestorage.app",
            messagingSenderId: "793497834481",
            appId: "1:793497834481:web:69dc5e8419fc7d467baa50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const COLLECTION_NAME = "schedules_v2"; // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒå¤‰ã‚ã‚‹ãŸã‚ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³åã‚’å¤‰æ›´

        let currentDate = new Date();
        let user = null;
        let scheduleData = {};
        let selectedDateKey = null;
        let editState = { dinner: null, plan: null };

        // --- æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
        const renderAll = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('month-display').textContent = `${year}å¹´ ${month + 1}æœˆ`;

            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();

            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
            const calContainer = document.getElementById('calendar-days');
            calContainer.innerHTML = '';
            for (let i = 0; i < firstDay; i++) calContainer.appendChild(document.createElement('div'));

            for (let d = 1; d <= daysInMonth; d
